name: Canary Deployment Template

# This workflow demonstrates a safe canary deployment pattern.
# It's a TEMPLATE that shows the stages without requiring real infrastructure.
# Customize it for your actual deployment needs (K8s, AWS, GCP, etc.)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: false
        default: 'v1.0.0'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

permissions:
  contents: read
  deployments: write
  issues: write

jobs:
  # STAGE 1: Pre-deployment checks
  prepare:
    name: ğŸ” Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.checks.outputs.ready }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run pre-deployment checks
        id: checks
        run: |
          echo "ğŸ” Running pre-deployment checks..."
          echo ""
          echo "Version: ${{ inputs.version || 'latest' }}"
          echo "Environment: ${{ inputs.environment }}"
          echo ""
          echo "Checking:"
          echo "âœ… Build artifacts exist"
          echo "âœ… Tests passed"
          echo "âœ… Security scans completed"
          echo "âœ… Dependencies up to date"
          echo ""
          echo "ready=true" >> $GITHUB_OUTPUT
      
      - name: Generate deployment plan
        run: |
          cat > deployment-plan.md << EOF
          # Deployment Plan
          
          **Version**: ${{ inputs.version || 'latest' }}
          **Environment**: ${{ inputs.environment }}
          **Strategy**: Canary (5% â†’ 25% â†’ 50% â†’ 100%)
          
          ## Stages
          1. Deploy to 5% of traffic (5 min monitoring)
          2. Increase to 25% (15 min monitoring)
          3. Increase to 50% (30 min monitoring)
          4. Full deployment to 100%
          
          ## Rollback Triggers
          - Error rate > 1%
          - P95 latency > 500ms
          - Health check failures
          - Manual intervention
          
          ## Monitoring
          - CloudWatch/Datadog/Prometheus dashboards
          - PagerDuty alerts configured
          - Slack notifications enabled
          EOF
          
          cat deployment-plan.md

  # STAGE 2: Canary deployment (5%)
  canary-5:
    name: ğŸ¤ Canary 5%
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.ready == 'true'
    environment:
      name: ${{ inputs.environment }}-canary
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy canary (5% traffic)
        run: |
          echo "ğŸš€ Deploying canary to 5% of traffic..."
          echo ""
          echo "EXAMPLE: Real deployment commands would go here:"
          echo "  kubectl set image deployment/app app=${{ inputs.version }}"
          echo "  aws deploy create-deployment --application my-app"
          echo "  gcloud app deploy --version=${{ inputs.version }}"
          echo ""
          echo "ğŸ“Š Simulating deployment..."
          sleep 2
          echo "âœ… Canary deployed to 5% of traffic"
      
      - name: Monitor canary health (5 min)
        run: |
          echo "ğŸ“Š Monitoring canary metrics..."
          
          # Simulate monitoring for demo (in reality, this would be longer)
          for i in {1..3}; do
            echo ""
            echo "Check $i/3 (simulated):"
            echo "  ğŸ“ˆ Request rate: 1,234 req/s"
            echo "  âš¡ P95 latency: 142ms (baseline: 150ms)"
            echo "  âŒ Error rate: 0.02% (threshold: 1%)"
            echo "  ğŸ’¾ Memory: 512MB (limit: 1GB)"
            echo "  ğŸ”¥ CPU: 35% (limit: 80%)"
            sleep 2
          done
          
          echo ""
          echo "âœ… All metrics within acceptable range"

  # STAGE 3: Increase to 25%
  canary-25:
    name: ğŸ¤ Canary 25%
    runs-on: ubuntu-latest
    needs: canary-5
    environment:
      name: ${{ inputs.environment }}-canary
    
    steps:
      - name: Increase canary traffic to 25%
        run: |
          echo "ğŸ“ˆ Increasing canary to 25% of traffic..."
          echo ""
          echo "EXAMPLE: Traffic split commands:"
          echo "  kubectl patch virtualservice my-app --type merge -p '{\"spec\":{\"http\":[{\"weight\":25}]}}'"
          echo "  aws elbv2 modify-target-group-attributes --target-group-arn arn:aws:elasticloadbalancing"
          echo ""
          sleep 2
          echo "âœ… Canary now serving 25% of traffic"
      
      - name: Extended monitoring (15 min)
        run: |
          echo "ğŸ“Š Extended monitoring at 25% traffic..."
          echo "In production, this would monitor for 15 minutes"
          echo ""
          
          # Simulate extended monitoring
          for i in {1..3}; do
            echo "Health check $i/3: âœ… PASSED"
            sleep 1
          done
          
          echo ""
          echo "âœ… No anomalies detected at 25% traffic"

  # STAGE 4: Increase to 50%
  canary-50:
    name: ğŸ¥ Canary 50%
    runs-on: ubuntu-latest
    needs: canary-25
    environment:
      name: ${{ inputs.environment }}-canary
    
    steps:
      - name: Increase canary traffic to 50%
        run: |
          echo "ğŸ“ˆ Increasing canary to 50% of traffic..."
          sleep 2
          echo "âœ… Canary now serving 50% of traffic"
      
      - name: Extended monitoring (30 min)
        run: |
          echo "ğŸ“Š Extended monitoring at 50% traffic..."
          echo "In production, this would monitor for 30 minutes"
          sleep 3
          echo "âœ… System stable at 50% traffic"

  # STAGE 5: Full deployment
  full-deployment:
    name: ğŸš€ Full Deployment (100%)
    runs-on: ubuntu-latest
    needs: canary-50
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Complete deployment to 100%
        run: |
          echo "ğŸš€ Completing deployment to 100% of traffic..."
          echo ""
          echo "EXAMPLE: Full deployment commands:"
          echo "  kubectl set image deployment/app-stable app=${{ inputs.version }}"
          echo "  kubectl delete deployment/app-canary"
          echo ""
          sleep 2
          echo "âœ… Version ${{ inputs.version }} deployed to 100% of traffic"
      
      - name: Post-deployment verification
        run: |
          echo "ğŸ” Running post-deployment checks..."
          echo ""
          echo "âœ… All instances healthy"
          echo "âœ… No error spike detected"
          echo "âœ… Performance metrics normal"
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"

  # STAGE 6: Rollback (only on failure)
  rollback:
    name: ğŸ”„ Automatic Rollback
    runs-on: ubuntu-latest
    needs: [canary-5, canary-25, canary-50, full-deployment]
    if: failure()
    
    steps:
      - name: Initiate rollback
        run: |
          echo "âš ï¸ Deployment failed - initiating rollback..."
          echo ""
          echo "EXAMPLE: Rollback commands:"
          echo "  kubectl rollout undo deployment/app"
          echo "  aws deploy stop-deployment --deployment-id xxx --auto-rollback"
          echo ""
          echo "ğŸ“§ Notifying team about rollback..."
          echo "âœ… Rollback completed"
      
      - name: Create incident report
        run: |
          echo "ğŸ“ Creating incident report..."
          cat > incident.md << EOF
          # Deployment Rollback Incident
          
          **Time**: $(date)
          **Version**: ${{ inputs.version }}
          **Environment**: ${{ inputs.environment }}
          **Stage Failed**: Check workflow logs
          
          ## Next Steps
          1. Review deployment logs
          2. Check monitoring dashboards
          3. Run root cause analysis
          4. Update runbooks if needed
          EOF
          
          echo "âœ… Incident report created"

  # Success notification
  notify-success:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: full-deployment
    if: success()
    
    steps:
      - name: Send success notification
        run: |
          echo "ğŸ“§ Sending success notification..."
          echo ""
          echo "EXAMPLE: Notification integrations:"
          echo "  - Slack: #deployments channel"
          echo "  - Email: devops@company.com"
          echo "  - PagerDuty: resolve incident"
          echo ""
          echo "Message:"
          echo "âœ… Successfully deployed ${{ inputs.version }} to ${{ inputs.environment }}"
          echo "Deployment completed in $(date)"