# CD with Safety Rails - Canary Deployments & Auto-Rollback

This document explains the continuous deployment workflow with built-in safety mechanisms including canary deployments, automatic rollbacks, and Claude-powered preparation and analysis.

## 🎯 Overview

The CD workflow provides:
- **Canary Deployments**: Gradual traffic increase (1% → 5% → 25% → 50% → 100%)
- **Auto-Rollback**: Instant rollback on metric degradation
- **Claude Preparation**: Migration PRs, checklists, verification scripts
- **Environment Approvals**: Manual gates for production
- **OIDC/WIF**: Secure cloud authentication without long-lived credentials

## 🚀 Quick Start

### Trigger Deployment

```bash
# Automatic deployment on merge to main
git push origin main

# Manual deployment with specific version
gh workflow run canary-deployment.yml \
  -f version=v2.3.0 \
  -f environment=production
```

### Monitor Progress

```bash
# Watch canary stages
gh run watch

# Check metrics
./scripts/deploy/check-canary.sh

# View Claude's analysis
@claude analyze current deployment
```

## 📊 Deployment Pipeline

### Flow Diagram

```
Prepare → Migrate → Canary 5% → Monitor → Canary 25% → Monitor → Canary 50% → Approve → 100% → Verify
   ↓         ↓          ↓                      ↓                      ↓                    ↓        ↓
Claude    If needed   Auto-rollback      Auto-rollback         Auto-rollback         Manual    Claude
Creates              on failure         on failure              on failure           Approval   Report
```

## 🤖 Claude's Role in CD

### 1. Pre-Deployment Preparation

Claude generates:

```bash
# Migration PR
/deploy-prepare migration --from v1.2.0 --to v2.0.0

# Creates:
migrations/
├── forward/
│   ├── 001_add_user_preferences.sql
│   └── 002_update_indexes.sql
└── rollback/
    ├── 001_remove_user_preferences.sql
    └── 002_restore_indexes.sql
```

### 2. Deployment Checklist

```markdown
# Generated Checklist for v2.3.0

## Pre-flight Checks
- [ ] All tests passing
- [ ] Performance benchmarks OK
- [ ] Security scan clean
- [ ] Database backup completed
- [ ] Rollback plan documented

## Stage 1: Canary 5% (30 min)
- [ ] Deploy to canary pods
- [ ] Verify health endpoints
- [ ] Check error rates
- [ ] Monitor p95 latency

## Success Criteria
- Error rate < 0.2%
- P95 latency < 250ms
- No memory leaks
```

### 3. Verification Scripts

Claude generates comprehensive verification:

```bash
#!/bin/bash
# Generated by Claude

# Health checks
check_endpoint "/health" 200
check_endpoint "/ready" 200

# Metrics validation
check_metric "error_rate" "<" 0.02
check_metric "latency_p95" "<" 500

# Integration tests
test_payment_flow
test_user_journey
```

### 4. Post-Deploy Analysis

```bash
@claude analyze deployment metrics

# Claude responds:
## Deployment Analysis - v2.3.0

### Performance Impact
- Latency: -12ms (improved) ✅
- Error Rate: +0.01% (acceptable) ✅
- Memory: +50MB (monitor) ⚠️

### Recommendations
1. Monitor memory for next 2 hours
2. Consider increasing cache size
3. All metrics within safe thresholds

### Decision: SAFE TO PROCEED
```

## 🚦 Canary Stages

### Stage 1: Initial Canary (1-5%)

```yaml
Duration: 30 minutes
Traffic: 5%
Auto-proceed: No (requires manual check)

Checks:
- Basic health endpoints
- Error rate baseline
- Critical user flows
```

### Stage 2: Early Adopters (25%)

```yaml
Duration: 2 hours
Traffic: 25%
Auto-proceed: Yes (if metrics OK)

Checks:
- Full metric comparison
- User engagement metrics
- Integration health
```

### Stage 3: Half Traffic (50%)

```yaml
Duration: 4 hours
Traffic: 50%
Auto-proceed: No (requires approval)

Checks:
- Load testing at scale
- Cost analysis
- Full functionality verification
```

### Stage 4: Full Deployment (100%)

```yaml
Duration: Monitoring only
Traffic: 100%
Auto-proceed: No (final approval required)

Actions:
- Update stable version
- Remove canary resources
- Archive metrics
```

## 🔄 Auto-Rollback Triggers

### Automatic Triggers

```yaml
# Instant rollback if:
error_rate: > 2%
latency_p95: > 500ms
success_rate: < 98%
memory_usage: > 85%
cpu_usage: > 80%
```

### Manual Triggers

```bash
# Emergency rollback
./scripts/deploy/rollback.sh production

# Rollback with reason
@claude rollback deployment "High memory usage detected"
```

### Rollback Process

```bash
1. Stop new traffic → canary
2. Redirect all traffic → stable
3. Scale down canary pods
4. Revert configuration
5. Notify team
6. Generate incident report
```

## 🔐 Environment Configuration

### Production Approvals

```yaml
production:
  protection_rules:
    required_reviewers:
      - team-lead
      - sre-oncall
    required_approvals: 2
    
  stages_requiring_approval:
    - 50%  → 100%  # Final production push
    - Any rollback  # Manual rollback decision
```

### OIDC Setup (AWS)

```yaml
# .github/environments/production.yml
aws:
  oidc:
    role_arn: "arn:aws:iam::123456:role/github-actions"
    permissions:
      - ecs:UpdateService
      - ecr:PutImage
      - secretsmanager:GetSecretValue
```

### Workload Identity (GCP)

```yaml
# .github/environments/production.yml  
gcp:
  workload_identity:
    service_account: "github@project.iam"
    permissions:
      - container.clusters.update
      - secretmanager.versions.access
```

## 📈 Monitoring During Deployment

### Real-time Metrics

```bash
# Watch canary metrics
./scripts/deploy/monitor-canary.sh --follow

# Output:
┌─────────────────────────────────┐
│ CANARY METRICS (5%)             │
├─────────────────────────────────┤
│ Error Rate:    0.08% ✅         │
│ P95 Latency:   187ms ✅         │
│ Success Rate:  99.92% ✅        │
│ Memory:        62% ✅           │
│ CPU:           45% ✅           │
├─────────────────────────────────┤
│ Status: HEALTHY                 │
│ Next Stage: 25% in 15 minutes   │
└─────────────────────────────────┘
```

### Claude Analysis

```bash
# Ask Claude about deployment
@claude should we proceed to 50%?

# Claude analyzes and responds:
Based on the last 2 hours of metrics:
- All thresholds are met ✅
- No anomalies detected ✅
- Cost increase: +2% (acceptable) ✅

Recommendation: SAFE TO PROCEED

One note: Slight memory increase (+8%)
Consider monitoring closely at 50%
```

## 🛑 Production Gates

### Approval Workflow

```yaml
Stage: 50% → 100%
Requires: 2 approvals from [team-lead, sre-oncall]

Notification:
  Slack: #deployments
  GitHub: Issue created
  PagerDuty: If critical

Timeout: 2 hours (auto-reject if no response)
```

### Approval Criteria

```markdown
## Production Approval Checklist

### Metrics (Last 4 Hours)
- [ ] Error rate < 0.1%
- [ ] No customer complaints
- [ ] All integrations healthy
- [ ] Cost within budget

### Verification
- [ ] Smoke tests passed
- [ ] Security scan clean
- [ ] Performance acceptable
- [ ] Rollback plan ready

### Team Readiness
- [ ] On-call engineer available
- [ ] Incident response ready
- [ ] Communication sent
```

## 🎯 Best Practices

### 1. Gradual Rollout

```bash
# Never skip stages
BAD:  1% → 100%
GOOD: 1% → 5% → 25% → 50% → 100%

# Allow soak time
BAD:  5 minutes per stage
GOOD: 30min → 2h → 4h → monitoring
```

### 2. Metric Validation

```bash
# Always compare canary vs stable
canary_error_rate / stable_error_rate < 1.5

# Check business metrics too
- Conversion rate
- User engagement  
- Revenue impact
```

### 3. Rollback Readiness

```bash
# Always test rollback procedure
./scripts/deploy/test-rollback.sh --dry-run

# Keep previous version warm
kubectl scale deployment/app-previous --replicas=2

# Document rollback time
Target: < 2 minutes
```

## 🚨 Emergency Procedures

### Immediate Rollback

```bash
# One-command rollback
./scripts/emergency-rollback.sh production

# What it does:
1. Diverts 100% traffic to stable
2. Scales down canary to 0
3. Pages on-call engineer
4. Creates incident ticket
5. Captures debug information
```

### Break-Glass Access

```bash
# Override all safety checks (use with extreme caution)
./scripts/deploy/force-deploy.sh \
  --skip-canary \
  --skip-tests \
  --skip-approval \
  --version hotfix-v2.3.1 \
  --reason "Critical security patch CVE-2024-1234"
```

## 📊 Success Metrics

### Deployment Metrics

```yaml
Lead Time: < 1 hour (commit to production)
Deployment Frequency: > 10/week
MTTR: < 5 minutes
Change Failure Rate: < 2%
Rollback Rate: < 5%
```

### Canary Effectiveness

```yaml
Issues Caught in Canary: > 90%
False Positive Rate: < 10%
Canary Duration: < 8 hours total
Auto-rollback Success: > 95%
```

## 🔄 Complete Example

### Successful Deployment

```bash
# 1. Merge to main
[14:00] PR merged, deployment triggered

# 2. Claude prepares
[14:01] Migration PR created
[14:02] Checklist generated
[14:03] Verification scripts ready

# 3. Canary begins
[14:05] 5% traffic → canary v2.3.0
[14:35] Metrics healthy, proceeding

# 4. Scale up
[14:36] 25% traffic → canary
[16:36] Auto-proceed to 50%
[16:37] 50% traffic → canary

# 5. Approval request
[20:37] Approval requested for 100%
[20:45] 2/2 approvals received

# 6. Full deployment
[20:46] 100% traffic → v2.3.0
[21:00] Verification passed
[21:01] Deployment complete ✅
```

### Deployment with Rollback

```bash
# 1. Canary starts
[14:00] 5% traffic → canary v2.4.0

# 2. Metrics degradation
[14:15] Error rate: 2.5% (threshold: 2%)
[14:16] Claude alerts: "Rollback recommended"

# 3. Auto-rollback
[14:17] Traffic → 100% stable
[14:18] Canary scaled to 0
[14:19] Team notified

# 4. Investigation
[14:20] Claude analysis: "Database connection pool exhausted"
[14:30] Fix implemented
[15:00] Retry deployment with fix
```

## 🎓 Learning from Deployments

### Claude generates post-deployment reports:

```markdown
# Deployment Report: v2.3.0

## Summary
- Duration: 7h 15m
- Stages: 5
- Rollbacks: 0
- Issues: 1 minor (memory increase)

## Lessons Learned
1. Memory usage increased 8% - need to optimize caching
2. Canary at 25% caught edge case in payment flow
3. Approval process took 8 minutes (good)

## Improvements for Next Time
1. Add memory profiling to canary checks
2. Increase soak time at 25% for payment features
3. Pre-warm database connections

## Team Performance
- Response time: Excellent
- Communication: Clear
- Decision making: Data-driven
```

Remember: **Every deployment is a learning opportunity. Claude helps you deploy safely and learn continuously!**