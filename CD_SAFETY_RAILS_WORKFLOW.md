# CD with Safety Rails - Canary Deployments & Auto-Rollback

This document explains the continuous deployment workflow with built-in safety mechanisms including canary deployments, automatic rollbacks, and Claude-powered preparation and analysis.

## ğŸ¯ Overview

The CD workflow provides:
- **Canary Deployments**: Gradual traffic increase (1% â†’ 5% â†’ 25% â†’ 50% â†’ 100%)
- **Auto-Rollback**: Instant rollback on metric degradation
- **Claude Preparation**: Migration PRs, checklists, verification scripts
- **Environment Approvals**: Manual gates for production
- **OIDC/WIF**: Secure cloud authentication without long-lived credentials

## ğŸš€ Quick Start

### Trigger Deployment

```bash
# Automatic deployment on merge to main
git push origin main

# Manual deployment with specific version
gh workflow run canary-deployment.yml \
  -f version=v2.3.0 \
  -f environment=production
```

### Monitor Progress

```bash
# Watch canary stages
gh run watch

# Check metrics
./scripts/deploy/check-canary.sh

# View Claude's analysis
@claude analyze current deployment
```

## ğŸ“Š Deployment Pipeline

### Flow Diagram

```
Prepare â†’ Migrate â†’ Canary 5% â†’ Monitor â†’ Canary 25% â†’ Monitor â†’ Canary 50% â†’ Approve â†’ 100% â†’ Verify
   â†“         â†“          â†“                      â†“                      â†“                    â†“        â†“
Claude    If needed   Auto-rollback      Auto-rollback         Auto-rollback         Manual    Claude
Creates              on failure         on failure              on failure           Approval   Report
```

## ğŸ¤– Claude's Role in CD

### 1. Pre-Deployment Preparation

Claude generates:

```bash
# Migration PR
/deploy-prepare migration --from v1.2.0 --to v2.0.0

# Creates:
migrations/
â”œâ”€â”€ forward/
â”‚   â”œâ”€â”€ 001_add_user_preferences.sql
â”‚   â””â”€â”€ 002_update_indexes.sql
â””â”€â”€ rollback/
    â”œâ”€â”€ 001_remove_user_preferences.sql
    â””â”€â”€ 002_restore_indexes.sql
```

### 2. Deployment Checklist

```markdown
# Generated Checklist for v2.3.0

## Pre-flight Checks
- [ ] All tests passing
- [ ] Performance benchmarks OK
- [ ] Security scan clean
- [ ] Database backup completed
- [ ] Rollback plan documented

## Stage 1: Canary 5% (30 min)
- [ ] Deploy to canary pods
- [ ] Verify health endpoints
- [ ] Check error rates
- [ ] Monitor p95 latency

## Success Criteria
- Error rate < 0.2%
- P95 latency < 250ms
- No memory leaks
```

### 3. Verification Scripts

Claude generates comprehensive verification:

```bash
#!/bin/bash
# Generated by Claude

# Health checks
check_endpoint "/health" 200
check_endpoint "/ready" 200

# Metrics validation
check_metric "error_rate" "<" 0.02
check_metric "latency_p95" "<" 500

# Integration tests
test_payment_flow
test_user_journey
```

### 4. Post-Deploy Analysis

```bash
@claude analyze deployment metrics

# Claude responds:
## Deployment Analysis - v2.3.0

### Performance Impact
- Latency: -12ms (improved) âœ…
- Error Rate: +0.01% (acceptable) âœ…
- Memory: +50MB (monitor) âš ï¸

### Recommendations
1. Monitor memory for next 2 hours
2. Consider increasing cache size
3. All metrics within safe thresholds

### Decision: SAFE TO PROCEED
```

## ğŸš¦ Canary Stages

### Stage 1: Initial Canary (1-5%)

```yaml
Duration: 30 minutes
Traffic: 5%
Auto-proceed: No (requires manual check)

Checks:
- Basic health endpoints
- Error rate baseline
- Critical user flows
```

### Stage 2: Early Adopters (25%)

```yaml
Duration: 2 hours
Traffic: 25%
Auto-proceed: Yes (if metrics OK)

Checks:
- Full metric comparison
- User engagement metrics
- Integration health
```

### Stage 3: Half Traffic (50%)

```yaml
Duration: 4 hours
Traffic: 50%
Auto-proceed: No (requires approval)

Checks:
- Load testing at scale
- Cost analysis
- Full functionality verification
```

### Stage 4: Full Deployment (100%)

```yaml
Duration: Monitoring only
Traffic: 100%
Auto-proceed: No (final approval required)

Actions:
- Update stable version
- Remove canary resources
- Archive metrics
```

## ğŸ”„ Auto-Rollback Triggers

### Automatic Triggers

```yaml
# Instant rollback if:
error_rate: > 2%
latency_p95: > 500ms
success_rate: < 98%
memory_usage: > 85%
cpu_usage: > 80%
```

### Manual Triggers

```bash
# Emergency rollback
./scripts/deploy/rollback.sh production

# Rollback with reason
@claude rollback deployment "High memory usage detected"
```

### Rollback Process

```bash
1. Stop new traffic â†’ canary
2. Redirect all traffic â†’ stable
3. Scale down canary pods
4. Revert configuration
5. Notify team
6. Generate incident report
```

## ğŸ” Environment Configuration

### Production Approvals

```yaml
production:
  protection_rules:
    required_reviewers:
      - team-lead
      - sre-oncall
    required_approvals: 2
    
  stages_requiring_approval:
    - 50%  â†’ 100%  # Final production push
    - Any rollback  # Manual rollback decision
```

### OIDC Setup (AWS)

```yaml
# .github/environments/production.yml
aws:
  oidc:
    role_arn: "arn:aws:iam::123456:role/github-actions"
    permissions:
      - ecs:UpdateService
      - ecr:PutImage
      - secretsmanager:GetSecretValue
```

### Workload Identity (GCP)

```yaml
# .github/environments/production.yml  
gcp:
  workload_identity:
    service_account: "github@project.iam"
    permissions:
      - container.clusters.update
      - secretmanager.versions.access
```

## ğŸ“ˆ Monitoring During Deployment

### Real-time Metrics

```bash
# Watch canary metrics
./scripts/deploy/monitor-canary.sh --follow

# Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CANARY METRICS (5%)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Error Rate:    0.08% âœ…         â”‚
â”‚ P95 Latency:   187ms âœ…         â”‚
â”‚ Success Rate:  99.92% âœ…        â”‚
â”‚ Memory:        62% âœ…           â”‚
â”‚ CPU:           45% âœ…           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: HEALTHY                 â”‚
â”‚ Next Stage: 25% in 15 minutes   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Claude Analysis

```bash
# Ask Claude about deployment
@claude should we proceed to 50%?

# Claude analyzes and responds:
Based on the last 2 hours of metrics:
- All thresholds are met âœ…
- No anomalies detected âœ…
- Cost increase: +2% (acceptable) âœ…

Recommendation: SAFE TO PROCEED

One note: Slight memory increase (+8%)
Consider monitoring closely at 50%
```

## ğŸ›‘ Production Gates

### Approval Workflow

```yaml
Stage: 50% â†’ 100%
Requires: 2 approvals from [team-lead, sre-oncall]

Notification:
  Slack: #deployments
  GitHub: Issue created
  PagerDuty: If critical

Timeout: 2 hours (auto-reject if no response)
```

### Approval Criteria

```markdown
## Production Approval Checklist

### Metrics (Last 4 Hours)
- [ ] Error rate < 0.1%
- [ ] No customer complaints
- [ ] All integrations healthy
- [ ] Cost within budget

### Verification
- [ ] Smoke tests passed
- [ ] Security scan clean
- [ ] Performance acceptable
- [ ] Rollback plan ready

### Team Readiness
- [ ] On-call engineer available
- [ ] Incident response ready
- [ ] Communication sent
```

## ğŸ¯ Best Practices

### 1. Gradual Rollout

```bash
# Never skip stages
BAD:  1% â†’ 100%
GOOD: 1% â†’ 5% â†’ 25% â†’ 50% â†’ 100%

# Allow soak time
BAD:  5 minutes per stage
GOOD: 30min â†’ 2h â†’ 4h â†’ monitoring
```

### 2. Metric Validation

```bash
# Always compare canary vs stable
canary_error_rate / stable_error_rate < 1.5

# Check business metrics too
- Conversion rate
- User engagement  
- Revenue impact
```

### 3. Rollback Readiness

```bash
# Always test rollback procedure
./scripts/deploy/test-rollback.sh --dry-run

# Keep previous version warm
kubectl scale deployment/app-previous --replicas=2

# Document rollback time
Target: < 2 minutes
```

## ğŸš¨ Emergency Procedures

### Immediate Rollback

```bash
# One-command rollback
./scripts/emergency-rollback.sh production

# What it does:
1. Diverts 100% traffic to stable
2. Scales down canary to 0
3. Pages on-call engineer
4. Creates incident ticket
5. Captures debug information
```

### Break-Glass Access

```bash
# Override all safety checks (use with extreme caution)
./scripts/deploy/force-deploy.sh \
  --skip-canary \
  --skip-tests \
  --skip-approval \
  --version hotfix-v2.3.1 \
  --reason "Critical security patch CVE-2024-1234"
```

## ğŸ“Š Success Metrics

### Deployment Metrics

```yaml
Lead Time: < 1 hour (commit to production)
Deployment Frequency: > 10/week
MTTR: < 5 minutes
Change Failure Rate: < 2%
Rollback Rate: < 5%
```

### Canary Effectiveness

```yaml
Issues Caught in Canary: > 90%
False Positive Rate: < 10%
Canary Duration: < 8 hours total
Auto-rollback Success: > 95%
```

## ğŸ”„ Complete Example

### Successful Deployment

```bash
# 1. Merge to main
[14:00] PR merged, deployment triggered

# 2. Claude prepares
[14:01] Migration PR created
[14:02] Checklist generated
[14:03] Verification scripts ready

# 3. Canary begins
[14:05] 5% traffic â†’ canary v2.3.0
[14:35] Metrics healthy, proceeding

# 4. Scale up
[14:36] 25% traffic â†’ canary
[16:36] Auto-proceed to 50%
[16:37] 50% traffic â†’ canary

# 5. Approval request
[20:37] Approval requested for 100%
[20:45] 2/2 approvals received

# 6. Full deployment
[20:46] 100% traffic â†’ v2.3.0
[21:00] Verification passed
[21:01] Deployment complete âœ…
```

### Deployment with Rollback

```bash
# 1. Canary starts
[14:00] 5% traffic â†’ canary v2.4.0

# 2. Metrics degradation
[14:15] Error rate: 2.5% (threshold: 2%)
[14:16] Claude alerts: "Rollback recommended"

# 3. Auto-rollback
[14:17] Traffic â†’ 100% stable
[14:18] Canary scaled to 0
[14:19] Team notified

# 4. Investigation
[14:20] Claude analysis: "Database connection pool exhausted"
[14:30] Fix implemented
[15:00] Retry deployment with fix
```

## ğŸ“ Learning from Deployments

### Claude generates post-deployment reports:

```markdown
# Deployment Report: v2.3.0

## Summary
- Duration: 7h 15m
- Stages: 5
- Rollbacks: 0
- Issues: 1 minor (memory increase)

## Lessons Learned
1. Memory usage increased 8% - need to optimize caching
2. Canary at 25% caught edge case in payment flow
3. Approval process took 8 minutes (good)

## Improvements for Next Time
1. Add memory profiling to canary checks
2. Increase soak time at 25% for payment features
3. Pre-warm database connections

## Team Performance
- Response time: Excellent
- Communication: Clear
- Decision making: Data-driven
```

Remember: **Every deployment is a learning opportunity. Claude helps you deploy safely and learn continuously!**